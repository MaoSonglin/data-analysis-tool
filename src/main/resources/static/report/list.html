<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>报表列表</title>
		<link rel="stylesheet" type="text/css" href="../static/plugins/layui/css/layui.css"/>
	</head>
	<body>
		<div class="layui-container">
			<div class="">
				<table id="report-list" class="layui-hide" border="" cellspacing="" cellpadding="" lay-filter="reportList">
					<tr><th>Header</th></tr>
					<tr><td>Data</td></tr>
				</table>
			</div>
		</div>
		<div id="dialog" style="display: ;">
			<div id="addform" style="display: none;margin: 15px;">
				<form action="#" method="" class="layui-form">
					<div class="layui-form-item">
						<label for="reportName" class="layui-form-label">报表名称</label>
						<div class="layui-input-block">
							<input class="layui-input" type="text" name="reportName" id="reportName" value=""v-model="report.name" />
						</div>
					</div>
					<div class="layui-form-item">
						<label for="pkgName" class="layui-form-label">业务集</label>
						<div class="layui-input-block">
							<select name="" id="pkgName" class="layui-select" lay-filter="pkgfilter">
								<option v-for="(pkg,index) in pkgs" v-bind:value="index" v-html="pkg.name"></option>
							</select>
						</div>
					</div>
					<div class="layui-form-item">
						<label for="reportComment" class="layui-form-label">描述</label>
						<div class="layui-input-block">
							<textarea rows="" cols="" class="layui-textarea" v-model="report.comment">
								
							</textarea>
						</div>
					</div>
				</form>
			</div>
			<div id="changePkg">
				<form action="#" method="" class="layui-form">
					
				</form>
			</div>
		</div>
		<div id="dialog2" style="display: none;margin: 15px;">
			<form class="layui-form" action="#" method="">
				<div class="layui-form-item">
					<label class="layui-form-label">节点：</label>
					<div class="layui-input-block">
						<input class="layui-input" type="text" name="text" id="menuText" value="" />
					</div>
				</div>
			</form>
			<ul id="myTree" class=""></ul>
		</div>
		
		<script type="text/html" id="toolbarDemo">
			<form class="layui-form" action="#">
				<div class="layui-form-item">
					<div class="layui-inline">
						<div class="layui-input-inline">
							<input type="" name="" id="keyword" value="" class="layui-input" lay-event="input" lay-filter="input" />
						</div>
						<button type="button" class="layui-btn layui-btn-warm" lay-event="search" lay-filter="search" >查询</button>
						<button type="button" class="layui-btn layui-btn-primary" lay-event="add">添加</button>
					</div>
				</div>
			</form>
		</script>
		<script type="text/html" id="publich_check">
			<!-- 这里的 checked 的状态只是演示 -->
			<input type="checkbox" name="publish" value="{{d.id}}" title="发布" lay-filter="publish" {{ d.publish ? 'checked' : '' }}>
		</script>

		<script type="text/html" id="barDemo">
			<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
			<!-- <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="publish">发布</a> -->
			<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
		</script>
		<script src="../static/plugins/jquery/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../static/plugins/layui/layui.all.js" type="text/javascript" charset="utf-8"></script>
		<script src="../static/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../res/js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../res/js/vue-resource.js" type="text/javascript" charset="utf-8"></script>
		<script src="../res/js/my-global.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			Vue.http.options.emulateJSON = true
			Vue.http.options.withCredentials = true
			layui.use("table",function(){
				var  table = layui.table.render({
					elem : "#report-list",
					url : basePath+"report/list",
					toolbar : "#toolbarDemo",
					height : 500,
					cols : [[
						{field : 'id',width : 180, title : '编号',sort : true,fixed: 'left'},
						{field : 'name', width : 120, title : '名称',edit:'text'},
						{field : 'pkgName', width : 200, title : '数据包', event:'setPkg'},
						{field : 'comment', minWidth: 200, title : '描述',edit : 'text'},
						{field : 'publish', title:'发布', width:110, templet: '#publich_check', unresize: true},
						{fixed : 'right', title:'操作', toolbar: '#barDemo', width:120}
					]],
					response : {
						statusCode : 1
					},
					parseData : function(res){
						return {
							"code" : res.code,
							"msg" : res.message,
							"count" : res.data.totalElements,
							"data" : res.data.content
						}
					},
					request : {
						pageName : "curPage",
						limitName : "pageSize"
					},
					page : true,
					limit : 5,
					limits : [5,10,15,20,25,30]
				})
				// 工具栏事件
				layui.table.on("toolbar(reportList)",function(obj){ 
					switch(obj.event){
						case  'search': // 搜索事件
						var keyword = $("#keyword").val()
						if(!keyword){
							layer.msg("请输入报表名称")
							break;
						}
						table.reload({
							where : {
								keyword : keyword
							},
							done : function(res,curr,cout){
								$("#keyword").val(keyword)
							}
						})
						break;
						case 'add' : // 新建报表事件
						add(table)
						break;
						case 'setPkg' : // 修改报表所属的业务包
						
						break;
					}
				})
				// 单元格编辑事件
				layui.table.on("edit(reportList)",function(obj){
					$.ajax({
						url : basePath+"report",
						method : "post",
						data : tile(obj.data),
						success : function(res){
							if(res.code != 1){
								layer.alert(res.message,function(index){
									table.reload()
									layer.close(index)
								})
							}
						}
					})
				})
				// 监听单元格事件
				layui.table.on("tool(reportList)",function(obj){
					switch(obj.event){
						case 'edit': // 编辑按钮点击
						localStorage['report'] = JSON.stringify(obj.data)
						window.parent.addParentTab({href:'report/create.html',title:'编辑报表:'+obj.data.name})
						break;
						case 'del': // 删除按钮点击
						layer.confirm("您确定要删除报表\""+obj.data.name+"\"吗？",{
							btn : ["确定","取消"]
						},function(index,layero){
							layer.close(index)
							var options = {
								url : basePath + "report",
								method : "post",
								data : tile(obj.data),
								success : function(res){
									if(res.code == 1){
										obj.del()
									}
								}
							}
							options.data.state = 0
							$.ajax(options)
						})
						break;
						case 'setPkg':
						layer.msg("can not modify this field now !")
						break;
						case 'publish':
						publish(obj.data)
						break;
						default:
						layer.alert("不支持的操作")
					}
				})
				
				layui.form.on('checkbox(publish)',function(obj){
					var that = this
					var reportid = this.value
					var menuid = null
					if(!obj.elem.checked){
						Vue.http.post(basePath+"report/unpublish/"+reportid).then(function(res){
							if(res.body.code == 1){
								table.reload()
							}
						})
						return ;
					}
					layer.open({
						type : 1,
						content : $("#dialog2"),
						area : ["500px","350px"],
						btn : ["确定","取消"],
						success : function(){
							Vue.http.get(basePath+"menu/").then(function(res){
								var nodes = [{id:0,spread:true,text:"目录菜单",children:res.body.data}]
								$("#myTree").empty()
								$("#menuText").val("")
								format(nodes)
								layui.use('tree',function(){
									layui.tree({
										elem : "#myTree",
										click: function(options){
											$("#menuText").val(options.name)
											menuid = options.id
										},
										nodes: nodes,
										skin: 'shihuang'
									})
								})
								function format(data){
									for(let i in data){
										data[i].name = data[i].text
										if(data[i].children){
											format(data[i].children)
										}
									} 
								}
							})
						},
						end : function(){
							$("#dialog2").hide()
							table.reload()
						},
						btn1 : function(index){
							if(menuid == null){
								layer.msg("请选择发布目录")
								return false;
							}
							layer.close(index)
							Vue.http.post(basePath+"report/publish/"+reportid+"/"+menuid).then(function(res){
								layer.msg(res.body.message)
							},function(error){layer.msg("网络异常");})
						}
					})
				})
				
			})
			
			
			
			function add(tableIns){
				layer.open({
					type : 1,
					content : $("#addform"),
					area : ["600px","400px"],
					btn : ["提交","取消"],
					success : function(){
						layui.use("form",function(){
							layui.form.render("select")
							layui.form.on("select(pkgfilter)",function(obj){
								vue.$emit("pkgIndex",obj.value)
							})
						})
					},
					end : function(){$("#addform").hide()},
					cancel : cancel,
					btn1 : ok,
					btn2 : cancel
				})
				
				function ok(index,layero){
					layer.confirm("您确定要提交吗？",{
						title : "确认",
						btn : ["确定","取消"]
					},function(i,l){
						layer.close(i)
						layer.close(index)
						submit()
					})
					
					function submit(){
						$.ajax({
							url : basePath + "report",
							method : "post",
							data : tile(vue.report),
							before : openLoading,
							complate : closeLoading,
							success : function(res){
								if(res.code == 1)
								tableIns.reload()
								else{
									layer.msg(res.message)
								}
							}
						})
					}
				}
				
				function cancel(index,layero){
					layer.confirm("您确定要放弃保存吗？",{
						title : "确认",
						btn : ["确定","取消"]
					},function(i,l){
						layer.close(i)
						layer.close(index)
					},function(i,l){
						return true;
					})
					return false;
				}
			}
			
			
			
			
			
			var vue = new Vue({
				el : '#dialog',
				data : {
					report : {},
					pkgs : []
				},
				created:function(){
					this.$http.get(basePath+"pkg").then(function(res){
						var data = res.body
						Vue.set(this,"pkgs",data.data.content)
					})
				}
			})
			
			vue.$on("pkgIndex",function(index){
				vue.report.pkg = vue.pkgs[index]
			})
			
			
		</script>
	</body>
</html>
